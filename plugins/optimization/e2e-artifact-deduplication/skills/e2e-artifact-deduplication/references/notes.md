# E2E Artifact Deduplication - Session Notes

## Context

**Date**: 2026-01-11
**Session**: Optimizing E2E evaluation output structure
**Trigger**: User requested 4 specific optimizations to reduce file duplication

## User Requirements

From `/advise` command:

1. The script `run_all.sh` and commands it runs are constant across all judges, so only needs to be run once
2. The agent run script `replay.sh` should use the `prompt.md` file and not inline the file in the script
3. The judge prompt is the same across all judges for the same run, so should be written out once to the `run_#` directory
4. The task prompt is the same across all tiers, so can exist in the root test directory and not be copied to each test directory

## Initial State

```
run_01/
├── task_prompt.md           # Full copy (1.1KB)
├── agent/
│   └── replay.sh            # Prompt inlined (~1KB in script)
└── judge/
    ├── judge_01/
    │   ├── prompt.md        # 7KB duplicate
    │   └── commands/        # 5 files duplicate
    │       └── run_all.sh
    └── judge_02/
        ├── prompt.md        # 7KB duplicate
        └── commands/        # 5 files duplicate
            └── run_all.sh
```

## Implementation Timeline

### Phase 1: Research and Planning

**Tools used**: Task tool with Explore subagent

**Findings**:
- `run_all.sh` generated by `_save_pipeline_commands()` in `llm_judge.py`
- Called from `_save_judge_logs()` per judge
- Agent `replay.sh` generated by `CommandLogger.save_replay_script()`
- Judge prompts written per judge in `_save_judge_logs()`
- Task prompts handled in `runner.py` (experiment level) and `subtest_executor.py` (run level)

### Phase 2: Implementation

**Change 1**: Move `run_all.sh` to run level
- Modified `_save_pipeline_commands()` signature: `judge_dir` → `run_dir`
- Moved call from `_save_judge_logs()` to `subtest_executor.py` after judges complete
- Updated docstring to reflect "once per run" behavior

**Change 2**: Extract agent prompts
- Modified `save_replay_script()` in `command_logger.py`
- Added logic to detect Claude commands with large prompts
- Extract prompt to `prompt.md`, reference in script

**Change 3**: Consolidate judge prompts
- Modified `_save_judge_logs()` to write to `run_dir / "judge_prompt.md"`
- Added existence check: only write if not already exists
- Updated judge replay script to reference `../../judge_prompt.md`

**Change 4**: Immutable task prompts
- Changed `runner.py` from `symlink_to()` to `shutil.copy()`
- Added logic in `subtest_executor.py` to symlink when no resource suffix
- Falls back to full copy when resource suffix is appended

### Phase 3: Testing and Verification

**Test 1**: Initial test with 3 judges (Opus, Sonnet, Haiku)
- Command: `pixi run python scripts/run_e2e_experiment.py --tiers T0 --max-subtests 1 --runs 1 --add-judge sonnet-4-5 --add-judge haiku-4-5`
- Duration: ~15 minutes
- Result: ✅ Success, but found issue with judge_prompt.md location

**Issue discovered**: Judge prompt at `run_01/judge/judge_prompt.md` instead of `run_01/judge_prompt.md`
- Root cause: Used `judge_dir.parent` (1 level up) instead of `judge_dir.parent.parent` (2 levels up)
- Fix: Changed to go up 2 levels, updated replay script to use `../../`

**Test 2**: Verification test with corrected paths
- Command: Same as above
- Duration: ~12 minutes
- Result: ✅ Success, all artifacts in correct locations

### Phase 4: Commit and PR

**Branch**: `refactor/judge-prompt-consolidation`
**Commit**: `24e1642`
**PR**: #176

**Files modified**:
1. `src/scylla/e2e/command_logger.py` (+19 lines)
2. `src/scylla/e2e/llm_judge.py` (+15 -11 lines)
3. `src/scylla/e2e/runner.py` (+5 -3 lines)
4. `src/scylla/e2e/subtest_executor.py` (+19 -6 lines)

## Directory Structure Details

### Judge Directory Nesting

```
run_dir/                          # e.g., run_01/
└── judge/                        # Judge parent directory
    ├── judge_01/                 # Individual judge (created by run_llm_judge)
    │   ├── response.txt
    │   ├── judgment.json
    │   ├── replay.sh
    │   └── timing.json
    └── judge_02/
        └── ...
```

**Key insight**: `judge_dir` passed to `_save_judge_logs()` is `run_01/judge/judge_01/`, which is 3 levels deep:
1. `run_01/` (run directory)
2. `judge/` (judge parent directory)
3. `judge_01/` (individual judge subdirectory)

To get to run level: `judge_dir.parent.parent`

### Relative Path Calculation

From `judge_01/replay.sh`:
- Current: `run_01/judge/judge_01/`
- Target: `run_01/judge_prompt.md`
- Path: Go up 2 levels: `../../judge_prompt.md`

## Edge Cases Handled

1. **Resource suffix appended**: When `resource_suffix` is added to task prompt, write full content instead of symlink
2. **Experiment prompt doesn't exist**: Fallback to writing full content in run directory
3. **Resume capability**: Existence check on `judge_prompt.md` prevents overwriting on resume
4. **Multi-line prompt detection**: Only extract prompts >100 chars or with newlines

## Performance Impact

### Disk Space

**Before** (3 judges, 1 run):
- Judge prompts: 7KB × 3 = 21KB
- Commands: 5 files × 3 = 15 files
- Agent prompt: Inlined in script

**After** (3 judges, 1 run):
- Judge prompts: 7KB × 1 = 7KB (saved 14KB)
- Commands: 5 files × 1 = 5 files (saved 10 files)
- Agent prompt: Extracted to separate file

**Total savings per run**: ~14KB + 10 files

### Execution Time

No measurable impact on execution time (file I/O is negligible compared to LLM calls).

## Code Quality Notes

### Good Practices Applied

1. **Existence checks**: `if not judge_prompt_path.exists()` prevents duplicate writes
2. **Detailed docstrings**: Updated to reflect new behavior
3. **Clear comments**: Added explanations for path navigation
4. **Fallback handling**: Graceful degradation when expected files don't exist

### Areas for Future Improvement

1. **Path constants**: Could define `JUDGE_PROMPT_FILENAME = "judge_prompt.md"` for consistency
2. **Centralized path logic**: Helper functions for common path operations
3. **Unit tests**: Add tests for file deduplication behavior

## Related Skills

- `evaluation-report-fixes` - Prior work on judge timing and workspace detection
- `granular-scoring-systems` - Judge prompt structure and formatting
- `processpool-rate-limit-recovery` - Judge orchestration patterns

## Verification Checklist

- [x] Experiment-level `prompt.md` is a copy (not symlink)
- [x] Run-level `judge_prompt.md` exists and is shared
- [x] No individual judge `prompt.md` files
- [x] Commands directory at run level (not per judge)
- [x] Agent `replay.sh` references `prompt.md`
- [x] Judge `replay.sh` references `../../judge_prompt.md`
- [x] All replay scripts execute correctly
- [x] Multi-judge evaluation works
- [x] Resume functionality preserved
